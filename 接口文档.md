## Service接口方法设计

下面是我为你深度思考后设计的Service接口、方法及其实现思路。我将按照数据库表的划分来组织各个Service。

---

### **1\. UsersService (用户服务)** Done

依赖的表: users  
关联的PRD功能: F-3.1.1 (个人偏好), F-3.4.2 (偏好学习), F-3.5.2 (探索朋友)

| 方法 | 功能描述 |
| :---- | :---- |
| Users findUserById(UUID userId) | **功能:** 根据用户ID查找用户 **参数:** userId 用户ID |
| Users getUserByUsername(String username) | **功能:** 根据用户名查找用户 **参数:** username 用户名 **返回值:** 用户信息 |
| Users createUser(String username, String preferencesText) | **功能:** 创建用户 **参数:** username 用户名, preferencesText 偏好文本 |
| Users updateUserPreferences(UUID userId, String preferencesText) | **功能:** 更新用户偏好设置 **参数:** userId 用户ID, preferencesText 偏好文本 **返回值:** 更新后的Users对象 |
| List<Users> findSimilarUsers(UUID userId, int limit) | **功能:** 查找兴趣相似用户 **参数:** userId 用户ID, limit 查找数量限制 **返回值:** 相似用户列表 |

---

### **2\. PoisService (兴趣点服务)** DONE

依赖的表: pois
关联的PRD功能: F-3.1.1 (智能推荐), F-3.1.3 (手动添加), F-3.5.1 (灵感激发)

| 方法 | 功能描述 |
| :---- | :---- |
| Pois getPoiById(UUID poiId) | **功能:** 根据ID获取POI详细信息 **参数:** poiId POI ID |
| List<Pois> searchPoiFromDb(String city, String keywords) | **功能:** 从数据库中批量获取POI信息 **参数:** city 城市名称, keywords 搜索的poi关键词 |
| List<Pois> searchPoiFromExternalApiAndSaveUpdate(@Nullable String city, String keywords, Integer searchNumber, Function<JSONArray, List<String>> generateDescriptions) | **功能:** 使用第三方API（高德/谷歌）搜索POI，并保存至数据库或更新数据库 **参数:** city 城市名称, keywords 搜索的POI关键词, searchNumber 搜索的POI数量, generateDescriptions 用于生成POI描述的函数 |
| List<Pois> searchPoiFromExternalApiAndSaveUpdate(@Nullable String city, String keywords) | **功能:** 重载方法，使用第三方API（高德/谷歌）搜索POI并保存至数据库，默认使用LLM生成POI描述 **参数:** city 城市名称, keywords 搜索的POI关键词 |
| void asyncEmbeddingAndSaveUpdate(List<Pois> poisList) | **功能:** 异步嵌入POI信息并保存到数据库 **参数:** poisList POI列表 |
| List<Pois> semanticSearchPois(String queryText, String city, int topK) | **功能:** 语义搜索POI，用于灵感激发模式 **参数:** queryText 查询文本, city 城市名称, topK 要查询的POI数量 |

---

### **3\. WishlistItemsService (心愿单服务)**

依赖的表: wishlist_items, pois  
关联的PRD功能: F-3.1.2 (心愿单系统)

| 方法 | 功能描述 |
| :---- | :---- |
| boolean addToWishList(UUID tripId, UUID entityId, boolean isPoi) | **功能:** 添加到心愿单 **参数:** tripId 行程ID, entityId 实体ID, isPoi 是否为POI |
| List<EntireWishlistItem> listEntireByTripId(UUID tripId) | **功能:** 获取某个行程下所有心愿单Item的详细信息，包含entity信息 **参数:** tripId 行程ID **返回值:** 按照添加的顺序倒序排序 |
| boolean removeFromWishList(List<UUID> itemIds) | **功能:** 删除心愿单中的item **参数:** itemIds 要删除的item ID列表 |

---

### **4\. TripsService (行程服务)**

依赖的表: trips, trip_days, trip_day_items
关联的PRD功能: F-3.1.4 (智能规划), F-3.1.6 (历史管理), F-3.3.1 (动态调整), F-3.4.3 (模板)

| 方法 | 功能描述 |
| :---- | :---- |
| Trips createTrip(UUID userId, TripDto dto) | **功能:** 创建行程 **参数:** userId 用户ID, dto 行程数据 |
| Trips updateTripInfo(UUID userId, TripDto dto) | **功能:** 更新行程信息 **参数:** userId 用户ID, dto 行程数据 |
| List<Trips> getAllTripsOfUser(UUID userId) | **功能:** 获取用户所有行程，按照创建时间倒序排序 **参数:** userId 用户ID **返回值:** 行程列表。如果用户没有行程，则返回空集合 |
| EntireTrip getEntireTrip(UUID userId, UUID tripId) | **功能:** 获取用户指定行程的全部信息，包括每个日程的详情 **参数:** userId 用户ID, tripId 行程ID |
| EntireTrip aiGenerateEntireTrip(UUID userId, UUID tripId) | **功能:** AI智能规划，生成整个行程 **参数:** userId 用户ID, tripId 行程ID |
| boolean deleteTrip(UUID userId, UUID tripId) | **功能:** 删除用户指定行程，级联删除该行程下的所有日程和日程下的所有item **参数:** userId 用户ID, tripId 行程ID |

---

### **5\. TripDaysService (日程服务)**

依赖的表: trip_days, trip_day_items
关联的PRD功能: F-3.1.4 (智能规划), F-3.3.1 (动态调整)

| 方法 | 功能描述 |
| :---- | :---- |
| TripDays createTripDay(UUID tripId, LocalDate date, String note) | **功能:** 创建行程中的日程，必须指定date **参数:** tripId 行程ID, date 日期, note 备注 |
| boolean updateTripDayNote(UUID tripDayId, String note) | **功能:** 更新日程的note **参数:** tripDayId 日程ID, note 备注 |
| EntireTripDay getEntireTripDay(UUID tripDayId) | **功能:** 获取行程中某天的详情，包括每个item **参数:** tripDayId 日程ID |
| List<EntireTripDay> getEntireTripDaysByTripId(UUID tripId) | **功能:** 获取行程中所有的日程详情，包括每个日程的item **参数:** tripId 行程ID **返回值:** 日程有序集合，按照日期进行排序。如果行程中没有日程，则返回空集合 |
| EntireTripDay aiRePlanTripDay(UUID tripDayId) | **功能:** AI智能规划，重新规划某天的行程 **参数:** tripDayId 日程ID |
| boolean exchangeDayOrder(UUID aTripDayId, UUID bTripDayId) | **功能:** 交换两个日程的顺序 **参数:** aTripDayId 第一个日程ID, bTripDayId 第二个日程ID |
| boolean deleteTripDays(List<UUID> tripDayIds) | **功能:** 删除行程中的日程，级联删除该日程下的所有item **参数:** tripDayIds 要删除的日程ID列表 |

---

### **6\. TripDayItemsService (日程项服务)**

依赖的表: trip_day_items
关联的PRD功能: F-3.1.4 (智能规划), F-3.3.1 (动态调整)

**内部类说明:**

**PoisTransportInfo:**
- name: 地点名称
- type: 类型
- city: 城市
- address: 地址
- latitude: 纬度
- longitude: 经度

**NonPoiTransportInfo:**
- title: 标题
- description: 描述
- city: 城市
- estimatedAddress: 预估地址
- extraInfo: 额外信息
- type: 类型

| 方法 | 功能描述 |
| :---- | :---- |
| TripDayItems addItems(UUID tripDayId, UUID entityId, boolean isPoi, LocalTime startTime, LocalTime endTime, BigDecimal estimatedCost) | **功能:** 添加POI、NonPoi到日程当中，默认为最后一个item **参数:** tripDayId 日程ID, entityId POI/NonPoi的ID, isPoi true:POI false:NonPoi, startTime 开始时间, endTime 结束时间, estimatedCost 预计花费 |
| boolean deleteItems(List<UUID> itemIds) | **功能:** 删除日程中的POI、NonPoi **参数:** itemIds 要删除的item ID列表 |
| TripDayItems updateItemInfo(TripDayItemDto dto) | **功能:** 更新日程item的信息，包括时间、花费、交通建议 **参数:** dto 日程item数据 |
| boolean moveItemOrder(UUID currentId, UUID prevId, UUID nextId, UUID tripDayId) | **功能:** 移动日程item的位置 **参数:** currentId 当前item的ID, prevId 前一个item的ID(如果移动到第一位，则为null), nextId 后一个item的ID(如果移动到最后一位，则为null), tripDayId 移动后所属的天(用于处理跨天移动的情况) |
| TripDayItems updateTransportNote(UUID itemId, @Nullable String originAddress) | **功能:** AI更新日程item的交通建议 **参数:** itemId 行程item ID, originAddress 起始地址(可为空) |
| List<TripDayItems> getItemsByTripDayId(UUID tripDayId) | **功能:** 获取某个日程中的所有item **参数:** tripDayId 日程ID **返回值:** items有序集合，若没有item则为空 |
| List<EntireTripDayItem> getEntireItemsByTripDayId(UUID tripDayId) | **功能:** 获取某个日程中的所有item，包括item的POI/NonPoi信息 **参数:** tripDayId 日程ID **返回值:** EntireTripDayItem有序集合，若没有item则为空 |

---

### **7\. AiRecommendationConversationService (AI推荐会话服务)**

依赖的表: ai_recommendation_conversation, ai_recommendation_items
关联的PRD功能: F-3.1.1 (智能推荐), F-3.5.1 (灵感激发)

| 方法 | 功能描述 |
| :---- | :---- |
| AiRecommendationConversation createConversation(UUID userId, String queryText) | **功能:** 创建会话 **参数:** userId 用户ID, queryText 查询文本 |
| AiRecommendationConversation renameConversation(UUID userId, UUID conversationId, String newTitle) | **功能:** 重命名会话 **参数:** userId 用户ID, conversationId 会话ID, newTitle 新标题 |
| AiRecommendResponse handleQuery(UUID userId, UUID conversationId, String queryText) | **功能:** 处理用户的对话 **参数:** userId 用户ID, conversationId 会话ID, queryText 查询文本 |
| AiRecommendationConversation searchConversationById(UUID userId, UUID conversationId) | **功能:** 根据id搜索会话 **参数:** userId 用户ID, conversationId 会话ID |
| List<Message> getConversationHistory(UUID userId, UUID conversationId) | **功能:** 获取指定会话的历史内容 **参数:** userId 用户ID, conversationId 会话ID |
| List<AiRecommendationConversation> getAllConversations(UUID userId) | **功能:** 获取所有会话 **参数:** userId 用户ID |
| boolean deleteConversation(UUID userId, UUID conversationId) | **功能:** 删除会话, 会话内所有内容也会被删除，包括记忆、工具调用结果（关联的webPage和aiRecommendationItem） **参数:** userId 用户ID, conversationId 会话ID |

---

### **8\. AiRecommendationItemsService (AI推荐项服务)**

依赖的表: ai_recommendation_items, pois, non_poi_item
关联的PRD功能: F-3.1.1 (智能推荐)

| 方法 | 功能描述 |
| :---- | :---- |
| List<Pois> getPoisItems(UUID userId, UUID conversationId, @Nullable Boolean isManual) | **功能:** 获取会话推荐的pois **参数:** userId 用户ID, conversationId 会话ID, isManual 是否为手动添加，如果为null返回所有 |
| List<NonPoiItem> getNonPoiItems(UUID userId, UUID conversationId,@Nullable Boolean isManual) | **功能:** 获取会话推荐的nonPoi **参数:** userId 用户ID, conversationId 会话ID, isManual 是否为手动添加，如果为null返回所有 |
| boolean addPois(UUID userId, UUID conversationId, List<UUID> poiIds, boolean isManual) | **功能:** 添加pois到会话推荐Item中 **参数:** userId 用户ID, conversationId 会话ID, poiIds POI ID列表, isManual 是否手动添加。除了AI提取网页内容后添加为自动添加（即extractItemsFromWebPageAndSave方法），其他均为手动添加 |
| boolean addPoisDirect(UUID userId, UUID conversationId, List<UUID> poiIds) | **功能:** 添加pois到会话推荐Item中，直接添加，不检查poiId是否存在 **用途:** 供extractItemsFromWebPageAndSave使用 **参数:** userId 用户ID, conversationId 会话ID, poiIds POI ID列表 |
| boolean addNonPoiItems(UUID userId, UUID conversationId, List<UUID> nonPoiItemIds, boolean isManual) | **功能:** 添加NonPoiItem到会话推荐Item中 **参数:** userId 用户ID, conversationId 会话ID, nonPoiItemIds NonPoiItem ID列表, isManual 是否手动添加 |
| boolean removePoisFromItems(UUID userId, UUID conversationId, @Nullable List<UUID> poiIds) | **功能:** 删除会话推荐中的pois，不级联删除pois **参数:** userId 用户ID, conversationId 会话ID, poiIds 要删除的poisId，如果为空，则删除该会话推荐中的所有 |
| boolean removeNonPoiFromItems(UUID userId, UUID conversationId, @Nullable List<UUID> nonPoiItemIds) | **功能:** 删除会话推荐中的NonPoiItem，不级联删除NonPoiItem **参数:** userId 用户ID, conversationId 会话ID, nonPoiItemIds 要删除的NonPoiItemId，如果为空，则删除该会话推荐中的所有 |
| boolean removeAllItems(UUID userId, UUID conversationId) | **功能:** 删除会话推荐中的所有Item **参数:** userId 用户ID, conversationId 会话ID |

---

### **9\. NonPoiItemService (非POI项服务)**

依赖的表: non_poi_item
关联的PRD功能: F-3.1.1 (智能推荐)

| 方法 | 功能描述 |
| :---- | :---- |
| boolean deleteByIds(UUID userId, List<UUID> nonPoiItemIds) | **功能:** 批量删除 **参数:** userId 用户ID, nonPoiItemIds 要删除的非POI项ID列表 |
| NonPoiItem createNonPoiItem(UUID userId, NonPoiItemDto dto) | **功能:** 创建 **参数:** userId 用户ID, dto 非POI项数据 |
| NonPoiItem updateNonPoiItem(UUID userId, NonPoiItemDto dto) | **功能:** 修改 **参数:** userId 用户ID, dto 非POI项数据 |
| List<NonPoiItem> getByUserId(UUID userId) | **功能:** 根据用户ID获取 **参数:** userId 用户ID |

---

### **10\. WebSearchService (网页搜索服务)**

依赖的表: web_page
关联的PRD功能: F-3.1.1 (智能推荐), F-3.5.1 (灵感激发)

| 方法 | 功能描述 |
| :---- | :---- |
| boolean deleteByConversationId(UUID conversationId) | **功能:** 删除会话下的所有网页 **参数:** conversationId 会话ID |
| List<WebPage> listByConversationId(UUID conversationId) | **功能:** 列出会话下的所有网页 **参数:** conversationId 会话ID |
| WebSearchResults webSearch(UUID conversationId, WebSearchParam param) throws IOException | **功能:** 搜索网页 **参数:** conversationId 会话ID, param 搜索参数 **返回值:** 搜索结果，包含原始查询、结果数量和网页列表 |
| ExtractResult extractItemsFromWebPageAndSave(UUID userId, String city, UUID webPageId) | **功能:** 从网页中提取信息,生成POI或NonPoiItem **参数:** userId 用户ID, city 城市。但会优先使用提取后得到的城市, webPageId 网页ID **返回值:** 提取的结果，包含POI和NonPoiItem的集合 |

**内部类说明:**

**WebSearchParam 参数说明:**
- query: 搜索关键字
- freshness: 搜索指定时间范围内的网页 (noLimit, oneDay, oneWeek, oneMonth, oneYear)
- summary: 是否显示文本摘要
- include: 指定搜索的网站范围。多个域名用|或,分隔
- exclude: 排除搜索的网站范围
- count: 指定返回的结果数量，1-50

**WebSearchResults:**
- originalQuery: 原始查询
- resultCount: 结果数量
- webPages: 网页列表

**ExtractResult:**
- message: 提取结果消息
- pois: POI列表
- nonPois: 非POI项列表

**ExtractionIntermediateResultDTO:**
- pois: 提取的POI列表
- nonPois: 提取的非POI列表

**ExtractedPoiDTO:**
- name: 景点名称
- city: 城市
- description: 描述

**ExtractedNonPoiDTO:**
- type: 非POI类型
- title: 标题
- description: 描述
- city: 城市
- activityTime: 活动时间
- estimatedAddress: 预估地址
- extraInfo: 额外信息

---

### **其他服务 (待扩展)**

以下服务标记为"to be expanded"，暂不提供具体方法实现：

- **ExpensesService** (支出服务) - 依赖表: expenses
- **PackingListItemsService** (打包清单服务) - 依赖表: packing_list_items  
- **PoiRatingsService** (POI评分服务) - 依赖表: poi_ratings
- **TripAiConversationHistoryService** (行程AI对话历史服务) - 依赖表: ai_conversation_history
- **TripLogsService** (行程日志服务) - 依赖表: trip_logs
- **TripMembersService** (行程成员服务) - 依赖表: trip_members

这些服务将在后续版本中根据实际需求进行详细设计和实现。
