## Service接口方法设计

下面是我为你深度思考后设计的Service接口、方法及其实现思路。我将按照数据库表的划分来组织各个Service。

---

### **1\. UsersService (用户服务)** Done

依赖的表: users  
关联的PRD功能: F-3.1.1 (个人偏好), F-3.4.2 (偏好学习), F-3.5.2 (探索朋友)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| Users findUserById(UUID userId) DONE | **功能:** 根据ID获取用户基本信息。 **思路:** 直接调用Mapper（MyBatis-Plus）的 selectById。 |
| Users getUserByUsername(String username) DONE | **功能:** 根据用户名查找用户（用于登录或检查重复）。 **思路:** 调用Mapper selectOne 配合Wrapper查询 username 字段。 |
| Users createUser(String username, String preferencesText) DONE | **功能:** 创建新用户。 **思路:** 1\. 调用 EmbeddingModel (Spring AI) 将 preferencesText 转换为 float\[\] 向量。 2\. 创建 Users 实体，填充 username、preferencesText 和 preferencesEmbedding。 3\. 调用Mapper insert 保存。 |
| Users updateUserPreferences(UUID userId, String newPreferencesText) DONE | **功能:** 更新用户的偏好（F-3.4.2）。 **思路:** 1\. 调用 EmbeddingModel 将 newPreferencesText 转换为新的 float\[\] 向量。 2\. 调用Mapper updateById，更新该 userId 对应的 preferences\_text 和 preferences\_embedding。 |
| List\<Users\> findSimilarUsers(UUID userId, int limit) DONE | **功能:** 探索兴趣相似的朋友（F-3.5.2）。 **思路:** 1\. 先调用 findUserById 获取当前用户的 preferences\_embedding 向量。 2\. 使用 pgvector 的向量相似度搜索（例如余弦距离）在 users 表中查找 preferences\_embedding 最接近的前 limit 个其他用户。 |

---

### **2\. PoisService (兴趣点服务)** DONE

依赖的表: pois  
关联的PRD功能: F-3.1.1 (智能推荐), F-3.1.3 (手动添加), F-3.5.1 (灵感激发)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| Pois getPoiById(UUID poiId) DONE | **功能:** 获取POI详细信息。 **思路:** 直接调用Mapper selectById。 |
| List<Pois> searchPoiFromExternalApi(String city, String keywords); DONE | **功能:** 从第三方API（高德/谷歌）获取POI。 **思路:** 调用API从第三方地图服务搜索POI，默认返回5个结果 |
| List<Pois> searchPoiFromDb(String city, String keywords); DONE | 功能：从数据库中获取POI。 |
| void asyncEmbeddingAndSave(List<Pois> poisList); DONE | 功能：事务方法，异步处理embedding向量并将pois写入数据库 |
| List<Pois> semanticSearchPois(String queryText, String city, int topK); DONE | **功能:** 用于灵感激发模式，根据模糊描述搜索地点（F-3.5.1）。 **思路:** 1\. 调用 EmbeddingModel 将 queryText 转换为 float\[\] 向量。 2\. 使用 pgvector 在 pois 表中对 description\_embedding 字段进行向量相似度搜索。<br />此外，该方法可以作为tool让大模型调用。 |

---

### **3\. WishlistService (心愿单服务)**

依赖的表: wishlist\_items, pois  
关联的PRD功能: F-3.1.2 (心愿单系统)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| void addToWishlist(UUID userId, UUID poiId) | **功能:** 添加到心愿单（F-3.1.2）。 **思路:** 创建一个 WishlistItems 实体（复合主键）并调用Mapper insert。 |
| void removeFromWishlist(UUID userId, UUID poiId) | **功能:** 从心愿单移除（F-3.1.2）。 **思路:** 调用Mapper delete，使用Wrapper匹配 user\_id 和 poi\_id。 |
| List\<Pois\> getWishlistForUser(UUID userId) | **功能:** 获取用户的所有心愿单地点（F-3.1.2）。 **思路:** 1\. 在 wishlist\_items 表中查询该 userId 对应的所有 poi\_id。 2\. 使用 PoisService 的 getPoiById（或一次性 selectBatchIds）查询所有POIs的详细信息。 |

---

### **4\. TripsService (行程服务)**

依赖的表: trips, trip\_days, itinerary\_items  
关联的PRD功能: F-3.1.4 (智能规划), F-3.1.6 (历史管理), F-3.3.1 (动态调整), F-3.4.3 (模板)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| Trips createNewTrip(UUID userId, String name, String destination, ...) | **功能:** 创建一个空的旅行计划。 **思路:** 创建 Trips 实体，设置 user\_id, name, status='PLANNING' 等，并 insert。 |
| Trips getTripWithDetails(UUID tripId) | **功能:** 获取行程的完整信息（包括所有天和所有活动项）。 **思路:** 1\. 调用Mapper selectById 获取 Trips。 2\. 调用 TripDaysService.getDaysForTrip(tripId) 获取 List\<TripDay\>。 3\. 遍历 TripDay 列表，调用 ItineraryItemsService.getItemsForDay(dayId) 获取活动项，并组装成一个完整的对象返回。 |
| List\<Trips\> getAllTripsForUser(UUID userId) | **功能:** 获取用户的所有历史行程（F-3.1.6）。 **思路:** 调用Mapper selectList，用Wrapper查询 user\_id 匹配的所有 Trips。 |
| void deleteTrip(UUID tripId) | **功能:** 删除行程（F-3.1.6）。 **思路:** 调用Mapper deleteById。由于DDL中设置了 ON DELETE CASCADE，相关的 trip\_days, itinerary\_items 等表记录会被自动删除。 |
| Trips generateFullItinerary(UUID tripId) | **功能:** 核心的AI智能行程规划（F-3.1.4）。 **思路:** 1\. 调用 getTripWithDetails(tripId) 获取当前行程、天数等。 2\. 调用 UsersService.findUserById(userId) 获取用户偏好 preferences\_text。 3\. 调用 WishlistService.getWishlistForUser(userId) 获取心愿单POI列表（含位置、营业时间）。 4\. 调用第三方API（高德/谷歌, 天气）获取地图和天气数据。 5\. **(核心)** 构造一个复杂的Prompt，包含所有信息（日期、偏好、心愿单、天气、交通），要求 Spring AI (ChatClient) 返回一个**结构化**的JSON，该JSON应符合 TripDays 和 ItineraryItems 的格式。 6\. **(核心)** 解析AI返回的JSON。 7\. （可选）先调用 TripDaysService.deleteDaysForTrip(tripId) 清空旧规划。 8\. 遍历解析结果，批量调用 TripDaysService.createTripDay 和 ItineraryItemsService.createItineraryItem 将新规划存入数据库。 |
| Trips adjustItinerary(UUID tripId, String changeRequest) | **功能:** 动态行程调整（F-3.3.1）。 **思路:** 类似 generateFullItinerary，但Prompt不同。 1\. 获取**现有**的行程（getTripWithDetails）。 2\. 将现有行程和 changeRequest（例如“今天下雨，把室外改成室内”）一起发给AI。 3\. AI返回调整后的JSON，然后解析并**更新** itinerary\_items 表。 |
| void saveTripAsTemplate(UUID tripId) | **功能:** 保存为模板（F-3.4.3）。 **思路:** 调用Mapper updateById，将该 tripId 的 is\_template 字段设为 true。 |

---

### **5\. TripDaysService & ItineraryItemsService**

依赖的表: trip\_days, itinerary\_items  
说明: 这两个通常是“内部”服务，主要被 TripsService 调用，提供CRUD功能。

| 服务 | 方法 | 功能描述与实现思路 |
| :---- | :---- | :---- |
| TripDaysService | List\<TripDays\> getDaysForTrip(UUID tripId) | **思路:** selectList 查询所有 trip\_id 匹配的 TripDays，按 day\_order 排序。 |
| TripDaysService | void createTripDay(...) | **思路:** insert 一条新的 TripDays 记录。 |
| TripDaysService | void deleteDaysForTrip(UUID tripId) | **思路:** delete 删除所有 trip\_id 匹配的 TripDays。 |
| ItineraryItemsService | List\<ItineraryItems\> getItemsForDay(UUID tripDayId) | **思路:** selectList 查询所有 trip\_day\_id 匹配的 ItineraryItems，按 item\_order 排序。 |
| ItineraryItemsService | void createItineraryItem(...) | **思路:** insert 一条新的 ItineraryItems 记录。 |
| ItineraryItemsService | void updateItineraryItem(...) | **思路:** updateById，用于用户手动拖拽或修改时间。 |

---

### **6\. AiConversationService (AI对话服务)**

依赖的表: ai\_conversation\_history  
关联的PRD功能: F-3.1.7 (行程专属AI对话)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| List\<AiConversationHistory\> getHistoryForTrip(UUID tripId) | **功能:** 获取某个行程的聊天历史。 **思路:** selectList 查询 trip\_id 匹配的记录，按 timestamp 升序排列。 |
| void addMessage(UUID tripId, RoleType role, String content) | **功能:** 保存一条聊天消息。 **思路:** insert 一条新的 AiConversationHistory 记录。 |
| String chatWithTripAi(UUID tripId, String userQuery) | **功能:** 核心的RAG（检索增强生成）聊天（F-3.1.7）。 **思路:** 1\. 调用 addMessage(tripId, RoleType.USER, userQuery) 保存用户提问。 2\. **(RAG \- 检索):**    a. 调用 getHistoryForTrip(tripId) 获取历史消息。    b. 调用 TripsService.getTripWithDetails(tripId) 获取当前行程的完整数据。 3\. **(RAG \- 生成):**    a. 构建Prompt，包含历史消息、行程数据，以及 userQuery。    b. 调用 Spring AI (ChatClient)。 4\. 获取AI回复 aiResponse。 5\. 调用 addMessage(tripId, RoleType.AI, aiResponse) 保存AI回复。 6\. 返回 aiResponse 给前端。 |

---

### **7\. PackingListService (打包清单服务)**

依赖的表: packing\_list\_items  
关联的PRD功能: F-3.2.2 (智能打包清单)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| List\<PackingListItems\> getPackingList(UUID tripId) | **功能:** 获取某行程的打包清单。 **思路:** selectList 查询 trip\_id 匹配的记录。 |
| List\<PackingListItems\> generatePackingList(UUID tripId) | **功能:** AI生成打包清单（F-3.2.2）。 **思路:** 1\. 调用 TripsService.getTripWithDetails(tripId) 获取目的地、时长、活动。 2\. 调用第三方API获取天气。 3\. 构建Prompt（目的地、天气、时长、活动），要求AI返回结构化的JSON清单。 4\. 解析AI返回的JSON，批量 insert 到 packing\_list\_items 表。 5\. 返回新生成的列表。 |
| PackingListItems toggleItemChecked(UUID itemId, boolean isChecked) | **功能:** 勾选/取消勾选物品。 **思路:** updateById 更新 is\_checked 字段。 |
| void deletePackingItem(UUID itemId) | **功能:** 手动删除物品。 **思路:** deleteById。 |

---

### **8\. PoiRatingService (地点评分服务)**

依赖的表: poi\_ratings, users  
关联的PRD功能: F-3.4.2 (行程评分与偏好学习)

| 方法 | 功能描述与实现思路 |
| :---- | :---- |
| void ratePoi(UUID userId, UUID poiId, int rating, String reviewText) | **功能:** 用户为地点打分（F-3.4.2）。 **思路:** 1\. insert 一条新的 PoiRatings 记录。 2\. **(异步触发)** 调用一个 @Async 方法。 |
| @Async void updateUserEmbeddingAfterRating(UUID userId) | **功能:** (内部异步方法) 更新用户的偏好向量（F-3.4.2）。 **思路:** 1\. 从 poi\_ratings 表中查询该 userId 的**所有**历史评分和评论 (review\_text)。 2\. 将这些文本拼接成一段新的、总结性的 preferencesText。 3\. 调用 UsersService.updateUserPreferences(userId, newPreferencesText) 来更新用户的偏好文本和向量。 |

---

### **9\. 其他服务 (Expenses, Logs, Members)**

这些服务相对独立，主要是CRUD（创建、读取、更新、删除）操作。

| 服务 | 方法 | 功能描述与实现思路 |
| :---- | :---- | :---- |
| ExpenseService | List\<Expenses\> getExpensesForTrip(UUID tripId) | **功能:** 获取行程的所有开销（F-3.3.4）。 **思路:** selectList 查询 trip\_id 匹配的记录。 |
| ExpenseService | Expenses addExpense(UUID tripId, ...) | **功能:** 添加一笔开销（F-3.3.4）。 **思路:** insert 一条 Expenses 记录。 |
| ExpenseService | BigDecimal getTotalExpenses(UUID tripId) | **功能:** 计算总花费，用于与预算对比（F-3.2.1）。 **思路:** SELECT SUM(amount) FROM expenses WHERE trip\_id \= ...。 |
| TripLogService | void addLog(UUID tripDayId, LogType type, String content) | **功能:** 添加旅行日志（照片URL或笔记）（F-3.4.1）。 **思路:** insert 一条 TripLogs 记录。 |
| TripLogService | List\<TripLogs\> getLogsForDay(UUID tripDayId) | **功能:** 获取一天的所有日志（F-3.4.1）。 **思路:** selectList 查询 trip\_day\_id 匹配的记录。 |
| TripLogService | String generateLogSummary(UUID tripId) | **功能:** AI辅助生成旅行故事线（F-3.4.1）。 **思路:** 1\. 获取该 tripId 的所有 TripLogs 和 ItineraryItems。 2\. 将这些数据发给 Spring AI (ChatClient)，要求它写一篇游记。 3\. 返回AI生成的字符串。 |
| TripMemberService | void inviteMember(UUID tripId, UUID userId, ...) | **功能:** 邀请朋友协作（F-3.2.4）。 **思路:** insert 一条 TripMembers 记录。 |
| TripMemberService | boolean checkPermission(UUID tripId, UUID userId, ...) | **功能:** 检查用户是否有权限编辑（用于安全校验）。 **思路:** selectOne 查询 trip\_members 表看是否存在及角色。 |

---

### 10.AiRecommendationConversationService

结合：ActivityService和AiRecommendationItemsService，提供综合推荐功能。

#### AiRecommendationConversationService：

| 方法                                                         | 功能描述与实现思路                  |
| :----------------------------------------------------------- | :---------------------------------- |
| AiRecommendationConversation createConversation(String userId, String queryText); | 功能：创建会话                      |
| AiRecommendResult aiRecommend(String userId, String conversationId, String city, String queryText); | 功能：ai搜索推荐，包括poi和activity |

#### AiRecommendationItemsService：

| 方法                                                      | 功能描述与实现思路               |
| :-------------------------------------------------------- | :------------------------------- |
| List<Pois> getPoisItems(String conversationId);           | 功能：获取会话中推荐的pois       |
| List<Activity> getActivitiesItems(String conversationId); | 功能：获取会话中推荐的activities |
